<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>문서 대시보드</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <link rel="stylesheet" href="./common.css" />

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#fff; }
    .wrap { max-width:1200px; margin:40px auto; padding:0 16px; }
    h2 { margin:0 0 6px; }
    .hint { color:#666; font-size:12px; margin:0 0 16px; }

    .filters { display:flex; gap:14px; flex-wrap:wrap; align-items:center; margin: 12px 0 18px; }
    .btn-group { display:flex; gap:6px; }
    .btn { padding:7px 12px; border:1px solid #ccc; background:#fff; cursor:pointer; font-size:13px; border-radius:8px; user-select:none; }
    .btn.active { background:#1f77b4; color:#fff; border-color:#1f77b4; }

    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom: 14px; }
    @media (max-width: 900px) { .kpi { grid-template-columns: 1fr; } }
    .kpi-card { border:1px solid #eee; border-radius:12px; padding:14px; background:#fff; }
    .kpi-title { color:#666; font-size:12px; margin-bottom:6px; }
    .kpi-val { font-size:22px; font-weight:700; }

    .donuts { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-bottom: 16px; }
    @media (max-width: 1100px) { .donuts { grid-template-columns: 1fr; } }
    .donut-card { border:1px solid #eee; border-radius:12px; padding:10px; background:#fff; }
    .donut-title { margin: 4px 6px 0; font-size:14px; color:#333; }

    .wc-card { border:1px solid #eee; border-radius:12px; padding:14px; background:#fff; }
    .wc-head { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .wc-title { margin:0; font-size:18px; }
    .wc-meta { color:#666; font-size:12px; }
    img { width:100%; height:auto; border-radius:10px; margin-top:10px; }
    .empty { border:1px dashed #ddd; border-radius:10px; padding:22px; color:#888; font-size:13px; text-align:center; margin-top:10px; }
  </style>
</head>

<body data-page="index">
  <div class="wrap">
    <h2>문서 대시보드</h2>

    <div class="filters">
      <div class="btn-group" id="scopeButtons">
        <button class="btn active" data-scope="전체" type="button">전체</button>
        <button class="btn" data-scope="내부" type="button">내부</button>
        <button class="btn" data-scope="외부" type="button">외부</button>
      </div>

      <div class="btn-group" id="yearButtons">
        <button class="btn active" data-year="전체" type="button">전체</button>
        <button class="btn" data-year="2024" type="button">2024</button>
        <button class="btn" data-year="2025" type="button">2025</button>
      </div>
    </div>

    <div class="kpi">
      <div class="kpi-card">
        <div class="kpi-title">총 문서 건수</div>
        <div class="kpi-val" id="kpiDocs">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">평균 결재 시간(주말 제외)</div>
        <div class="kpi-val" id="kpiTime">-</div>
      </div>
    </div>

    <div class="donuts">
      <div class="donut-card">
        <div class="donut-title">시행종류</div>
        <div id="donutIE" style="height:300px;"></div>
      </div>
      <div class="donut-card">
        <div class="donut-title">공개여부</div>
        <div id="donutDisclose" style="height:300px;"></div>
      </div>
      <div class="donut-card">
        <div class="donut-title">붙임파일</div>
        <div id="donutAttach" style="height:300px;"></div>
      </div>
    </div>

    <div class="wc-card">
      <div class="wc-head">
        <h3 class="wc-title" id="wcTitle">워드클라우드</h3>
        <div class="wc-meta" id="wcMeta">-</div>
      </div>
      <div id="wcContent"></div>
    </div>
  </div>

  <script>
    // index.json을 로드해서 여기 담음
    let PACK = null;

    let currentScope = "전체";
    let currentYear = "전체";

    function setActive(buttons, activeBtn) {
      buttons.forEach(b => b.classList.remove("active"));
      activeBtn.classList.add("active");
    }

    function fmtInt(n) { return (n ?? 0).toLocaleString(); }
    function fmtTime(v) {
      if (v === null || v === undefined || Number.isNaN(v)) return "N/A";
      return Number(v).toFixed(2);
    }

    function donut(divId, obj) {
      const labels = Object.keys(obj || {});
      const values = labels.map(k => obj[k]);

      const COLORS = ["#A7C7E7", "#B8E0C8", "#FFD6A5"]; // 3색 팔레트

      const trace = {
        type: "pie",
        labels,
        values,
        hole: 0.62,
        textinfo: "percent",
        hoverinfo: "label+value+percent",
        marker: {
          colors: labels.map((_, i) => COLORS[i % COLORS.length]),
          line: { color: "#ffffff", width: 2 } // 경계선(선택)
        }
      };

      const layout = {
        margin: { l: 10, r: 10, t: 10, b: 10 },
        showlegend: true,
        legend: { orientation: "h" }
      };

      Plotly.react(divId, [trace], layout, { responsive: true });
    }


    function render() {
      if (!PACK) return; // 아직 로딩 전이면 렌더 스킵

      const key = currentScope + "|" + currentYear;
      const p = PACK[key];

      // 키가 없으면 안전 처리
      if (!p) {
        document.getElementById("kpiDocs").textContent = "0건";
        document.getElementById("kpiTime").textContent = "N/A";
        donut("donutIE", {});
        donut("donutDisclose", {});
        donut("donutAttach", {});
        document.getElementById("wcMeta").textContent = "데이터 없음 (" + key + ")";
        document.getElementById("wcContent").innerHTML = "<div class='empty'>표시할 데이터가 없습니다.</div>";
        return;
      }

      document.getElementById("kpiDocs").textContent = fmtInt(p.n_docs) + "건";
      document.getElementById("kpiTime").textContent = fmtTime(p.avg_time) + "일";

      donut("donutIE", p.donut_ie);
      donut("donutDisclose", p.donut_disclose);
      donut("donutAttach", p.donut_attach);

      document.getElementById("wcMeta").textContent = "표본 수: " + fmtInt(p.n_docs) + "건";

      const wc = document.getElementById("wcContent");
      wc.innerHTML = p.wc_img
        ? ("<img src='" + p.wc_img + "' alt='wordcloud' />")
        : "<div class='empty'>표시할 키워드가 없습니다.</div>";
    }

    async function loadPack() {
      try {
        const res = await fetch("./index.json", { cache: "no-store" });
        if (!res.ok) throw new Error("index.json 로드 실패: HTTP " + res.status);
        PACK = await res.json();
        render();
      } catch (err) {
        console.error(err);
        document.getElementById("wcMeta").textContent = "데이터 로드 실패";
        document.getElementById("wcContent").innerHTML =
          "<div class='empty'>index.json을 불러오지 못했습니다. (콘솔 확인)</div>";
      }
    }

    const scopeBtns = Array.from(document.querySelectorAll("#scopeButtons .btn"));
    scopeBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentScope = btn.dataset.scope;
        setActive(scopeBtns, btn);
        render();
      });
    });

    const yearBtns = Array.from(document.querySelectorAll("#yearButtons .btn"));
    yearBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentYear = btn.dataset.year;
        setActive(yearBtns, btn);
        render();
      });
    });

    loadPack();
  </script>

  <script src="./nav.js"></script>
</body>
</html>
